<!DOCTYPE html>
<html>
<head>
    <title>maptalks.toolbox demo</title>
    <script src="https://unpkg.com/maptalks@<2.0.0/dist/maptalks.min.js"></script>
    <script src="../dist/maptalks.toolbox.js"></script>
    <!-- <script src="../dist/maptalks.toolbox.css"></script> -->
    <link type="text/css" rel="stylesheet" href="https://unpkg.com/maptalks@<2.0.0/dist/maptalks.css">
    <style>
        #map { width: 1100px; height: 800px; }
    </style>
</head>
<body>
<div id="map"></div>
<script>
    var map = new maptalks.Map("map",{
        center:      [0, 0],
        zoom:  2,
        attributionControl : {
            'content' : '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy; <a href="https://carto.com/attributions">CARTO</a>'
        },
        baseLayer : new maptalks.TileLayer("base",{
            'urlTemplate' : 'http://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}.png',
            'subdomains'  : ['a','b','c','d','e']
        })
    });

    var layer = new maptalks.VectorLayer('layer').addTo(map);
    map.on('click', clickMap);

    addMarker(new maptalks.Coordinate(0,0));

    function clickMap(param) {
        var coordinate = param.coordinate;
        addMarker(coordinate);
    }
    
    function addMarker(coordinate) {
        map.off('click', clickMap);
        var path = [{
            path:'M0.266084 0c0.146933,0 0.266084,0.119151 0.266084,0.266084 0,0.0724431 -0.0289833,0.138123 -0.0759576,0.186109l-0.0949907 0.110753 -0.0856567 0.0997072 0.117919 0 0 0.0218934 -0.24432 0 0 -0.0218934 0.107444 0 -0.0856491 -0.0997072 -0.0949984 -0.110753c-0.0469743,-0.047986 -0.0759576,-0.113666 -0.0759576,-0.186109 0,-0.146933 0.119151,-0.266084 0.266084,-0.266084zm0 0.034605c0.127823,0 0.231479,0.103655 0.231479,0.231479 0,0.127823 -0.103655,0.231479 -0.231479,0.231479 -0.127823,0 -0.231479,-0.103655 -0.231479,-0.231479 0,-0.127823 0.103655,-0.231479 0.231479,-0.231479z',
            'fill-rule':'evenodd'
        }];
        var symbol = {
            'markerType' : 'path',
            'markerPath' : path,
            'markerPathWidth' : 0.6,
            'markerPathHeight' : 0.7,
            'markerWidth': 20,
            'markerHeight': 20,
            'markerFill': '#ff0000'
        };

        var markerId = 'Marker'+ maptalks.Util.UID();
        //创建点对象
        var marker = new maptalks.Marker(coordinate,{'draggable':true,'id':markerId});
        layer.addGeometry(marker);
        var toolbox = addToolboxToMarker(marker);
        marker.on('click', function(){
            toolbox.show();
        });
        marker.on('remove', function(){
            map.on('click', clickMap);
        });
    }


    function addToolboxToMarker(marker) {
        var editIcon = 'images/resize.png';
        var editIconText = 'resize it.';
        if(marker.isEditing()) {
            editIcon = 'images/end_resize.png';
            editIconText = 'resize end.';
        }
        var toolbox = new maptalks.Toolbox({
            autoPan: true,
            vertical : false,
            //工具项
            items: [{
                icon: 'images/trash.png',
                title: 'remove marker.',
                width: 16,
                height: 16,
                mouseout: function(event){
                    var target = getEventTarget(event);
                    target.src = 'images/trash.png';
                },
                mouseover: function(event){
                    var target = getEventTarget(event);
                    target.src = 'images/trash_hover.png';
                },
                click : function(){
                    if(confirm('Confirm remove this marker?')){
                        if(marker.isEditing()) {
                            alert('End edit first!');
                            return;
                        }
                        toolbox.remove();
                        marker.remove();
                    }
                }
            }, {
                icon: editIcon,
                title: editIconText,
                width: 16,
                height: 16,
                click : function(event){
                    var target = getEventTarget(event);
                    var imageUrl = target.src;
                    if(imageUrl.indexOf('/resize.png')>0){
                        marker.startEdit({'fixAspectRatio' :true});
                        target.src = 'images/end_resize.png';
                    } else {
                        target.src = 'images/resize.png';
                        marker.endEdit();
                    }
                }
            }, {
                icon: 'images/close.png',
                title: 'close toolbar',
                width: 16,
                height: 16,
                mouseout: function(event) {
                    var target = getEventTarget(event);
                    target.src = 'images/close.png';
                },
                mouseover: function(event) {
                    var target = getEventTarget(event);
                    target.src = 'images/close_hover.png';
                },
                click : function(){
                    toolbox.hide();
                }
            }]
        });
        toolbox.addTo(marker);
        toolbox.show();
        return toolbox;
    }

    function getEventTarget(e){
         e = window.event || e;
        return e.srcElement || e.target;
    }

</script>
</body>
</html>
